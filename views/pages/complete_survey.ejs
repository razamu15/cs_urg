<html>

<head>
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
    <link rel="stylesheet" href="/css/standard.css">
    <title>Answer Survey</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.24.0/moment.min.js"></script>
    <style>
        #main_resp{
            margin: 12px;
            
        }
    </style>
</head>

<body>
    <%- include('../partials/navbar', {action:"logout", home:"userhome"}) %>
    <div id="content">
            
            

            <h2 class="sub-header"><%= survey.title %></h2>
        <p id="survey_info"><%= survey.info %></p>

        <form action="/userhome/survey/<%= survey.survey_id %>" method="POST"
            enctype='application/x-www-form-urlencoded' id="main_resp">
            <% for ( each_ques of questions) { %>
            <% qnum = each_ques.ques_order_num %>

            <div name="<%= qnum %>" id="<%= qnum %>" style="display: none" data-count="<%= each_ques.ques_count%>">

                <% if (qtypes[each_ques.ques_type_id].has_file) { %>
                <% for (i = 0; i < each_ques.ques_count; i++) { %>
                <% filenum = i; %>
                <div name="<%= qnum %>_<%= filenum %>" id="<%= qnum %>_file_<%= filenum %>" style="display: none">


                    <h3 class="ques_title"><%= each_ques.title %></h3>
                    <h5 class="ques_info"><%= each_ques.info %></h5>
                    <input type="text" id="<%=qnum%>_<%=filenum%>_qid" name="<%=qnum%>_<%=filenum%>_qid"
                        value="<%= each_ques.ques_id %>" style="display: none">
                    <input type="text" id="<%=qnum%>_<%=filenum%>_fid" name="<%=qnum%>_<%=filenum%>_fid"
                        value="file-id-fill" style="display: none" id="<%=qnum%>_<%=filenum%>_fid">

                    <a class="file_link" id="<%=qnum%>_<%=filenum%>_link" href="file-link-fill%>" target="_blank">File
                        Link Here</a><br>

                    <% if (qtypes[each_ques.ques_type_id].has_text) { %>
                    <textarea class="resp_text" name="<%=qnum%>_<%= filenum %>_text"></textarea>
                    <% } %>
                    <% if (qtypes[each_ques.ques_type_id].has_options) { %>
                    <div class="opts_cont">
                        <% for (each_opt of each_ques.options) { %>
                        <% opnum = each_opt.id %>
                        <% if (each_opt.text_associated == 1) { %>
                        <input type="radio" name="<%=qnum%>_<%= filenum %>_opt" id="<%=qnum%>_<%= filenum %>_opt"
                            value="<%= opnum %>" class="text"> <%= each_opt.label %>:
                        <input type="text" name="<%=qnum%>_<%= filenum %>_opt_text"
                            id="<%=qnum%>_<%= filenum %>_opt_text" disabled>
                        <% } else { %>
                        <input type="radio" name="<%=qnum%>_<%= filenum %>_opt" value="<%= opnum %>" class="no_text">
                        <%= each_opt.label %>
                        <% } %>
                        <% } %>
                    </div>
                    <% } %>
                </div>
                <% } %>
            </div>
            <% } else { %>
            <h3 class="ques_title"><%= each_ques.title %></h3>
            <h3 class="ques_info"><%= each_ques.info %></h3>
            <input type="text" name="<%=qnum%>_id" value="<%= each_ques.ques_id%>" style="display: none">

            <% if (qtypes[each_ques.ques_type_id].has_text) { %>
            <textarea class="resp_text" name="<%=qnum%>_text"></textarea>
            <% } %>
            <% if (qtypes[each_ques.ques_type_id].has_options) { %>
            <div class="opts_cont">
                <% for (each_opt of each_ques.options) { %>
                <% opnum = each_opt.id %>
                <% if (each_opt.text_associated == 1) { %>
                <input type="radio" id="<%=qnum%>_opt" name="<%=qnum%>_opt" value="<%= opnum %>" class="text">
                <%= each_opt.label %>:
                <input type="text" name="<%=qnum%>_opt_text" id="<%=qnum%>_opt_text" disabled>
                <% } else { %>
                <input type="radio" name="<%=qnum%>_opt" value="<%= opnum %>" class="no_text"> <%= each_opt.label %>
                <% } %>
                <% } %>
            </div>
            <% } %>
        </div>
            <% } %>

            <% } %>
            <input type="submit" value="Submit">
            <button type="button" id="next_ques">Next Question</button>
        </form>
        <div id="done" style="display: none">
            <p>no more questions left, please click the submit button to confirm your responses</p>
        </div>

    </div>
    <script>
        var surv_size;
        var ques_counter;
        var ques_file_total;
        var ques_file_counter;

        // this fucntion will hide the last question and show the next ques when the user clicks the button
        function show_next_ques() {
            // hide the last question and we add the input feild with the time-end
            time_end = `<input type="text" name="${ques_counter}_time_end" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
            $(`#${ques_counter}`).append(time_end);
            $(`#${ques_counter}`).hide();
            // increase the ques counter and use the new value to add the time start for the new ques and make it visible to the user
            ques_counter += 1;
            // update the ques file counter information
            ques_file_counter = 0;
            ques_file_total = $(`#${ques_counter}`).data('count');
            // add start time to next question and show it
            $(`#${ques_counter}`).show();
            time_start = `<input type="text" name="${ques_counter}_time_start" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
            $(`#${ques_counter}`).prepend(time_start);
            // check if this is the final question cz if it is tell the user survey is done
            if (ques_counter == surv_size) {
                $(`#done`).show();
            }
        }

        function show_next_file() {
            // update the last file feildset with the end time and hide it
            time_end = `<input type="text" name="${ques_counter}_${ques_file_counter}_time_end" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
            $(`#${ques_counter}_file_${ques_file_counter}`).append(time_end);
            $(`#${ques_counter}_file_${ques_file_counter}`).hide();
            // update the counter
            ques_file_counter += 1;
            // add the time start to and show the next file feildset
            time_start = `<input type="text" name="${ques_counter}_${ques_file_counter}_time_start" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
            $(`#${ques_counter}_file_${ques_file_counter}`).prepend(time_start);
            // show the first file feildset for this question that will be asked for multiple files
            $(`#${ques_counter}_file_${ques_file_counter}`).show();
            // use ajax / jquery to get a file and link it for this question
            // get the ques_id to send with the request for a file
            qid = $(`#${ques_counter}_${ques_file_counter}_qid`).attr('value');
            file_obj = $.getJSON(`/getfile/ques/${qid}`, function (data) {
                // set the link attribute from the file object
                $(`#${ques_counter}_${ques_file_counter}_link`).attr('href', data.link);
                // set the value for the file id in the corresponsing input feild
                $(`#${ques_counter}_${ques_file_counter}_fid`).attr('value', data.file_id);
            }).fail(function (d, textStatus, error) {
                // if the getJSON request failed and it was because of status 422 which is sent by webserver when its out of files
                // then we dont make subsequent requests file requests and move onto the next question
                if (d.status == 422) {
                    console.log("Ran out of files to serve, moving to next question");
                    show_next_ques();
                } else {
                    console.error("Something went wrong in requesting file");
                }
            });
        }

        $(document).ready(function () {
            surv_size = $("#main_resp").children().length - 2;
            ques_counter = 0;
            ques_file_total = $(`#${ques_counter}`).data('count');
            ques_file_counter = 0;
            // show the first question
            $(`#${ques_counter}`).show();
            // we check if we show the whole first question itself or the first file of the first question
            if (ques_file_total == 1) {
                // show the first question and also add the time start
                time_start = `<input type="text" name="${ques_counter}_time_start" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
                $(`#${ques_counter}`).prepend(time_start);
            } else {
                // otherwise show the next file
                time_start = `<input type="text" name="${ques_counter}_${ques_file_counter}_time_start" value="${moment().format('YYYY-MM-DD HH:mm:ss')}" style="display: none">`;
                $(`#${ques_counter}_file_${ques_file_counter}`).prepend(time_start);
                // show the first file feildset for this question that will be asked for multiple files
                $(`#${ques_counter}_file_${ques_file_counter}`).show();
                // use ajax / jquery to get a file and link it for this question
                // get the ques_id to send with the request for a file
                qid = $(`#${ques_counter}_${ques_file_counter}_qid`).attr('value');
                file_obj = $.getJSON(`/getfile/ques/${qid}`, function (data) {
                    // set the link attribute from the file object
                    $(`#${ques_counter}_${ques_file_counter}_link`).attr('href', data.link);
                    // set the value for the file id in the corresponsing input feild
                    $(`#${ques_counter}_${ques_file_counter}_fid`).attr('value', data.file_id);
                }).fail(function (d, textStatus, error) {
                // if the getJSON request failed and it was because of status 422 which is sent by webserver when its out of files
                // then we dont make subsequent requests file requests and move onto the next question
                if (d.status == 422) {
                    console.log("Ran out of files to serve, moving to next question");
                    show_next_ques();
                } else {
                    console.error("Something went wrong in requesting file");
                }
            });
            }


            $("#next_ques").click(function () {
                // if the ques_file_counter is 1 less than ques file total, then we show the next question ow show the next subfeild for the question
                if (ques_file_counter == (ques_file_total - 1)) {
                    show_next_ques();
                } else {
                    show_next_file();
                }
            });

            $("#main_resp").submit(function (event) {
                // if the user presses the submit button before the end of the survey we send an alert to tell them they are not done
                if (ques_counter != surv_size) {
                    alert("There are still unanswered questions");
                    event.preventDefault();
                }
            });

            // this handler will enable the text entry feild for a text option, which by default will be disabled
            $(document).on('click', ".text", function () {
                text_input_id = '#' + $(this).attr('id') + '_text';
                $(text_input_id).prop('disabled', false);
            })

        })

    </script>
</body>

</html>