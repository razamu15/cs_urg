<html>

<head>
    <title>this is da page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <style>
        body{
            background-color: gray;
        }
    </style>
</head>

<body>
    <h1>Create Survey Page</h1>
    <div id="form_wrap">


        <form action="/create_survey" method="POST" enctype='application/x-www-form-urlencoded'>
            <fieldset name="survey_data" id="survey_data">
                <legend>Enter the Survey related info Here</legend>

                <label for="surv_title">Enter the Survey Title:</label>
                <input type="text" name="surv_title" id="surv_title">
                <br>
                <label for="surv_info">Enter Survey Info if there is any: </label>
                <textarea name="surv_info" id="surv_info"></textarea>
            </fieldset>
            <br>
            <fieldset name="questions" id="questions">
                <legend>Enter the Questions Related info here</legend>

            </fieldset>
                <input type="submit" value="Submit">
                <button type="button" id="reset_survey">Reset</button>
        </form>

        <!-- this form is separate from the actualy survey cration form and is only used for creating a ques,
        i need to make a separate form bcz i need to value of the qtype_dropdown which comes with form submission -->
        <form id="create_ques">
            New Ques Type:
            <select name="qtype_dropdown" id="qtype_dropdown">
                <option value="0">--</option>
                <% for (const row of ques_types_query) { %>
                <option value="<%= row.ques_type_id %>"><%= row.label %></option>
                <% } %>
            </select>
            <br><br>
            <input type="submit" value="Create New Ques">
        </form>
    </div>


    <script>
        // define a var to keep track of how many question we have created for this survey
        // and how many options we have created for a question
        qnum = 0;
        opnum = 0;
        // this variable is to track the state if there is an open/unsaved ques or not
        unsaved_ques = false;
        // lets first grab the query result that was given to us when the template was rendered
        ques_types = <%- JSON.stringify(ques_types_query) %>;

        // required when using jquery and also so we dont mess things up
        $(document).ready(function () {

            // this is the handler for the button that will let the user reset the form if they make a mistake
            $("#reset_survey").click(function(){
                location.reload();
            });

            // this handler will be used to create a question template for the user to fill out
            // this is an intercepter to the default form submit event which is a post request
            $("#create_ques").submit(function (event) {
                // here check to make sure that there are no open questions before we let user make another question
                if (unsaved_ques){
                    alert("save the previous question before making the next one");
                    event.preventDefault();
                    return;
                }
                // we get which type of question we need to create then render the question template accordingly
                form_data = $(this).serializeArray();
                // now we use the id value we have from the form submission to get additional
                // data from the saved query result we need to render the question
                var show_text, show_options, show_file;
                for (const row of ques_types) {
                    if (form_data[0].value == row.ques_type_id) {
                        show_text = row.has_text;
                        show_options = row.has_options;
                        show_file = row.has_file;
                    };
                };
                // fill in the question creation template with the current values of these variables
                ques_template = `<fieldset name="${qnum}">
                        <input type="text" name="${qnum + '_type_id'}" id="${qnum + '_type_id'}" value="${form_data[0].value}">
                        Question text: <input type="text" name="${qnum + '_title'}" id="${qnum + '_title'}"><br>
                        Question info: <input type="text" name="${qnum + '_info'}" id="${qnum + '_info'}"><br>
                        <div id="${qnum + '_file'}">
                            <input type="text" name="${qnum + '_count'}" id="${qnum + '_count'}" placeholder="Enter Question count">
                            <a href="#">File Link Here</a><br>
                        </div>
                        <span id="${qnum + '_text'}">open ended response: <textarea disabled></textarea></span>
                        <div id="${qnum + '_opts'}">
                            <button type="button" id="create_opts" >Create New Option</button>
                            <button type="button" id="create_text_opts" >Create Text Entry Option</button>
                        </div>
                        <!-- this extra save button will stop the question from being editable anymore
                            and it will also make the create option button and itself dissappear for this question-->
                            <button type="button" id="save_ques" >Save Question</button>
                    </fieldset>`;
                // append the question creation template to the questions feild inside the form
                $("#questions").append(ques_template);
                // after adding the default template, we use the settings we found earlier so only show what is
                // applicable for this type of question
                if (!show_file) {
                    // if the question, doesnt have a file attach then the count defaults to one
                    $(`#${qnum + '_count'}`).val(1);
                    $(`#${qnum + '_file'}`).hide();
                } 
                if (!show_text) {$(`#${qnum + '_text'}`).hide();}
                if (!show_options) {$(`#${qnum + '_opts'}`).hide();}
                // and we also wanna always hide the type if from the user because it doesnt concern them
                $(`#${qnum + '_type_id'}`).hide();
                // set the question state tracking variable
                unsaved_ques = true;

                event.preventDefault();
            });

            $(document).on('click', "#save_ques", function(){
                // remove the button to add more options
                $("#create_opts").remove();
                $("#create_text_opts").remove();
                // disable all the other input fields
                $(`#${qnum + '_title'}`).prop("readonly", true);
                $(`#${qnum + '_info'}`).prop("readonly", true);
                $(`#${qnum + '_text'}`).prop("readonly", true);
                // now we loop through all the individual options and disable those
                for (let each_opt = 0; each_opt < opnum; each_opt++) {
                    $(`#${qnum + '_op_' + each_opt}`).prop("readonly", true);
                };
                // hide the save button itself for this question
                $(this).remove();
                // increse the question number counter for the next ques
                // you can only create a new qustion once you have saved the old one
                qnum += 1;
                opnum = 0;
                unsaved_ques = false;
            });

            $(document).on('click', "#create_opts", function(){
                // add this line to the current question numbers options div
                option_template = `<input type="text" name="${qnum + '_op_' + opnum}" id="${qnum + '_op_' + opnum}" placeholder="Enter Option Label">`;
                // increase opnum for next option that will be created
                $(`#${qnum + '_opts'}`).prepend(option_template);
                opnum += 1;
            });

            $(document).on('click', "#create_text_opts", function(){
                // add this line to the current question numbers options div
                option_template = `<input type="text" name="${qnum + '_txtop_' + opnum}" id="${qnum + '_op_' + opnum}" placeholder="Enter Option Label">:<input type="text" disabled>`;
                // increase opnum for next option that will be created
                $(`#${qnum + '_opts'}`).prepend(option_template);
                opnum += 1;
            });

        })
    </script>
</body>

</html>